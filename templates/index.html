<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Petal for You - Flask版</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Petal for You</h1>
        <p class="subtitle">Each petal falls for you, each verse recalls you.</p>

        <label><input type="radio" name="mode" value="relay" checked> 诗词接龙</label>
        <label><input type="radio" name="mode" value="feihua"> 飞花令</label><br>
        <input type="text" id="keyword" placeholder="输入拼音或关键词">
        <button onclick="startGame()">开始游戏</button>

        <div id="gameArea" style="display:none;">
            <div id="history"></div>
            <input type="text" id="userInput" placeholder="请输入你的诗句">
            <button onclick="submitLine()">提交</button>
            <button onclick="autoAnswer()">你帮我答</button>
        </div>
    </div>

<script>
let mode = "relay";
let keyword = "";
let history = [];

function startGame() {
    mode = document.querySelector("input[name='mode']:checked").value;
    keyword = document.getElementById("keyword").value.trim();
    history = [];
    document.getElementById("history").innerHTML = "";
    document.getElementById("gameArea").style.display = "block";

    fetch("/get_line", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({mode: mode, prev: "", keyword: keyword})
    }).then(res => res.json()).then(data => {
        history.push({player: "Bot", line: data.line});
        updateHistory();
    });
}

function submitLine() {
    const userInput = document.getElementById("userInput").value.trim();
    if (!userInput) return;
    history.push({player: "You", line: userInput});
    updateHistory();
    document.getElementById("userInput").value = "";

    fetch("/get_line", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            mode: mode,
            prev: userInput,
            keyword: keyword,
            used: history.map(h => h.line)
        })
    }).then(res => res.json()).then(data => {
        history.push({player: "Bot", line: data.line});
        updateHistory();
    });
}

function autoAnswer() {
    const lastLine = history.length > 0 ? history[history.length - 1].line : "";

    fetch("/get_line", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            mode: mode,
            prev: lastLine,
            keyword: keyword,
            used: history.map(h => h.line)
        })
    }).then(res => res.json()).then(data => {
        // 系统代替用户答一句
        history.push({player: "You", line: data.line});
        updateHistory();

        // 然后继续由系统对一句
        fetch("/get_line", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                mode: mode,
                prev: data.line,
                keyword: keyword,
                used: history.map(h => h.line)
            })
        }).then(res => res.json()).then(data2 => {
            history.push({player: "Bot", line: data2.line});
            updateHistory();
        });
    });
}

function updateHistory() {
    document.getElementById("history").innerHTML =
        history.map(h => `<div><strong>${h.player}:</strong> ${h.line}</div>`).join("");
}
</script>
</body>
</html>
